# Kaiten Webhook Bot

–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ Kaiten –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏—Ö –æ—Ç—á—ë—Ç–æ–≤.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ü—Ä–∏—ë–º webhook –æ—Ç Kaiten –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π (90 –¥–Ω–µ–π)
- ‚úÖ –£—á—ë—Ç —Ç–∏–ø–∞ –ª–∏—Ü–∞ (—Ñ–∏–∑/—é—Ä) –∏ —Å–ø–æ—Å–æ–±–∞ –ø–æ–¥–∞—á–∏ (–ï–ü–ì–£/–ú–§–¶/–õ–∏—á–Ω—ã–π –ø—Ä–∏—ë–º)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ –≤ Telegram (—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –≤ 08:30)
- ‚úÖ –†—É—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É
- ‚úÖ –¢–æ—á–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
cd /home/user1/projects/kaiten-webhook-bot
pip3 install fastapi uvicorn requests python-dotenv --break-system-packages
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env —Ñ–∞–π–ª

```bash
nano .env
```

```env
# Telegram
TELEGRAM_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞
TELEGRAM_CHAT_ID=–≤–∞—à_chat_id

# –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
DATA_FILE=/home/user1/projects/kaiten-webhook-bot/moves_by_date.json
DATA_RETENTION_DAYS=90

# –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD)
HOLIDAYS=2025-01-01,2025-01-02,2025-12-31
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
nohup python3 app.py > output.log 2>&1 &
```

### 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ Kaiten

**URL:** `http://–≤–∞—à_—Å–µ—Ä–≤–µ—Ä:8000/gradplan_process`  
**–°–æ–±—ã—Ç–∏–µ:** `card:update`

## üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã

–û—Ç—á—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Telegram –∫–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –≤ **08:30** (–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫ UTC+7).

–í –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç—á—ë—Ç –∑–∞ **–ø—è—Ç–Ω–∏—Ü—É**, –≤ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–Ω–∏ - –∑–∞ **–ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å**.

### –†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞

```bash
# –û—Ç—á—ë—Ç –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É
python3 app.py --report 2025-12-31 --send

# –¢–æ–ª—å–∫–æ –≤—ã–≤–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (–±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏)
python3 app.py --report 2025-12-31
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç—á—ë—Ç–∞

```
üìä –ü–æ—Ç–æ–∫ –∑–∞ 2025-12-31

‚Ä¢ –ü—Ä–∏–Ω—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É (–ø–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞): 5
‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –≤ –†–°–û: 3
‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –ì–ü–ó–£: 8
‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –æ—Ç–∫–∞–∑—ã: 2
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ì–ü–ó–£ –Ω–∞—á–∞–ª—å–Ω–∏–∫–æ–º –æ—Ç–¥–µ–ª–∞: 7
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ì–∞–±–∏–¥—É–ª–∏–Ω–æ–π –†.–†.: 6
‚Ä¢ –ü–æ–¥–ø–∏—Å–∞–Ω—ã –ì–ü–ó–£: 4
‚Ä¢ –í–Ω–µ—Å–µ–Ω–æ –≤ –ì–ò–°–û–ì–î (–≥—Ä–∞–¥–ø–ª–∞–Ω—ã): 3
‚Ä¢ –í–Ω–µ—Å–µ–Ω–æ –≤ –ì–ò–°–û–ì–î (–æ—Ç–∫–∞–∑—ã): 1
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

–í—Å–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `moves_by_date.json`:

```json
{
  "2025-12-31": {
    "moves": [
      {
        "card_id": "59291491",
        "title": "14909 –ú–∞–Ω—É–∫—è–Ω –†–æ–±–µ—Ä—Ç –ê—Ç–∞–±–µ–∫–æ–≤–∏—á",
        "person_type": "–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ",
        "submission_method": "–ï–ü–ì–£",
        "from_column_id": 5474972,
        "from_column": "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¢–£ —É –†–°–û",
        "to_column_id": 5485743,
        "to_column": "WIP –û–ñ–ò–î–ê–ù–ò–ï",
        "user": "isogd.2019",
        "timestamp": "2025-12-31T11:34:20+07:00"
      }
    ]
  }
}
```

## üîç –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Ç–∏–ø–∞–º –ª–∏—Ü

```bash
cat moves_by_date.json | jq '[.["2025-12-31"].moves[] | .person_type] | group_by(.) | map({type: .[0], count: length})'
```

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –ø–æ–¥–∞—á–∏

```bash
cat moves_by_date.json | jq '[.["2025-12-31"].moves[] | .submission_method] | group_by(.) | map({method: .[0], count: length})'
```

### –ò—Å—Ç–æ—Ä–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏

```bash
cat moves_by_date.json | jq '.["2025-12-31"].moves[] | select(.card_id == "59291491")'
```

### –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

```bash
cat moves_by_date.json | jq '.["2025-12-31"].moves | group_by(.user) | map({user: .[0].user, moves: length}) | sort_by(-.moves)'
```

### –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV

```bash
cat moves_by_date.json | jq -r '.["2025-12-31"].moves[] | [.card_id, .title, .person_type, .submission_method, .from_column, .to_column, .user, .timestamp] | @csv' > report.csv
```

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

```bash
ps aux | grep "python3 app.py"
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

```bash
tail -f output.log
```

### –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
pkill -f "python3 app.py"
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å

```bash
pkill -f "python3 app.py"
sleep 2
nohup python3 app.py > output.log 2>&1 &
```

### –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

```bash
# –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä!
pkill -f "python3 app.py"
sleep 2
echo '{}' > moves_by_date.json
nohup python3 app.py > output.log 2>&1 &
```

## üîß API Endpoints

- `GET /` - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
- `POST /gradplan_process` - webhook –æ—Ç Kaiten
- `GET /test_report` - —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç –∑–∞ –≤—á–µ—Ä–∞
- `GET /stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ö—Ä–∞–Ω–∏–ª–∏—â—É

### –ü—Ä–∏–º–µ—Ä—ã

```bash
# –°—Ç–∞—Ç—É—Å
curl http://localhost:8000/

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl http://localhost:8000/stats

# –¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
curl http://localhost:8000/test_report
```

## üìã –ú–µ—Ç—Ä–∏–∫–∏ –≤ –æ—Ç—á—ë—Ç–∞—Ö

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª–µ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ |
|---------|----------------|
| –ü—Ä–∏–Ω—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É | –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¢–û–ü–û, –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç–∫–∞–∑ |
| –í—ã–ø–æ–ª–Ω–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –≤ –†–°–û | WIP –û–ñ–ò–î–ê–ù–ò–ï |
| –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –ì–ü–ó–£ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –æ—Ç–¥–µ–ª–∞ |
| –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –æ—Ç–∫–∞–∑—ã | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ì–∞–±–∏–¥—É–ª–∏–Ω–∞ –†.–†. (–æ—Ç–∫–∞–∑—ã) |
| –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞—á–∞–ª—å–Ω–∏–∫–æ–º | –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è |
| –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ì–∞–±–∏–¥—É–ª–∏–Ω–æ–π | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ì–∞–±–∏–¥—É–ª–∏–Ω–∞ –†.–†. |
| –ü–æ–¥–ø–∏—Å–∞–Ω—ã –ì–ü–ó–£ | –í–Ω–µ—Å—Ç–∏ –≤ –ì–ò–°–û–ì–î (–≥—Ä–∞–¥–ø–ª–∞–Ω—ã) |
| –í–Ω–µ—Å–µ–Ω–æ –≤ –ì–ò–°–û–ì–î (–≥—Ä–∞–¥–ø–ª–∞–Ω—ã) | –í–Ω–µ—Å—Ç–∏ –≤ –ò–°–û–ì–î –∏ –∞—Ä—Ö–∏–≤ |
| –í–Ω–µ—Å–µ–Ω–æ –≤ –ì–ò–°–û–ì–î (–æ—Ç–∫–∞–∑—ã) | –í–Ω–µ—Å—Ç–∏ –≤ –ò–°–û–ì–î |

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤–æ–π—Å—Ç–≤ –∫–∞—Ä—Ç–æ—á–µ–∫

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç:

**–¢–∏–ø –ª–∏—Ü–∞ (id_270916):**
- 93406 ‚Üí –§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ
- 93407 ‚Üí –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ

**–°–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏ (id_270924):**
- 93413 ‚Üí –ï–ü–ì–£
- 93414 ‚Üí –ú–§–¶
- 93415 ‚Üí –õ–∏—á–Ω—ã–π –ø—Ä–∏—ë–º

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—Ç—á—ë—Ç—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram:
```bash
cat .env | grep TELEGRAM
```

### –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏

–ü–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π JSON **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
pkill -f "python3 app.py"
sleep 2
echo '{}' > moves_by_date.json
nohup python3 app.py > output.log 2>&1 &
```

### –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
tail -20 output.log
```

–î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
```
[INFO] ‚úÖ card_id: ... | title: ... | —Ç–∏–ø: ... | –ø–æ–¥–∞—á–∞: ...
[MOVE] ...
[PERSIST] ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
```

### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω:
```bash
ps aux | grep "python3 app.py"
curl http://localhost:8000/
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ Kaiten:
- URL: `http://–≤–∞—à_—Å–µ—Ä–≤–µ—Ä:8000/gradplan_process`
- –°–æ–±—ã—Ç–∏–µ: `card:update`

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ:
1. –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤: `tail -50 output.log`
2. –í–µ—Ä—Å–∏—é Python: `python3 --version`
3. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .env (–±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤)
4. –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –æ—Ç–¥–µ–ª–∞ –≥—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
